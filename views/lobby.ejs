<!DOCTYPE html>
<html>

<head>
  <title>
    <%= title %>
  </title>
  <link rel='stylesheet' href='/stylesheets/style.css' />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script type="text/javascript" src="/socket.io/socket.io.js"></script>

  <!-- 합쳐지고 최소화된 최신 CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
  <!-- 부가적인 테마 -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
  <!-- 합쳐지고 최소화된 최신 자바스크립트 -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>

  <script type="text/javascript">
    var userid = "<%= sess.mem_ID %>";
    var userrooms = [];


    function search() {
      console.log($('#searchText').val());
      if ($('#searchText').val() != '') {
        $('#container').empty();
        $('#paging').empty();
        $.ajax({
          type: 'GET',
          url: "./lobby/searchRoom",
          data: {
            "searchText": $('#searchText').val()
          },
          success: function(data) {
            $.each(data, function(index, item) {
              $('<button></button>').attr({
                'id': item.roomname,
                'data-toggle': "modal",
                'data-target': "#enterRoom"
              }).text('방이름: ' + item.roomname + ' 방장: ' + item.userid).appendTo('#container');
            })
          }
        });
      } else if ($('#searchText').val() == '') {
        refresh(1);
      }
    }



    function refresh(j) {

      $('#container').empty();
      $('#paging').empty();

      $.getJSON('/lobby/roomList/' + j, function(data) {
        userrooms = data.userrooms;

        var end = data.begin + data.size;
        if (end > data.cnt) {
          end = data.cnt
        }
        console.log(end);
        console.log(data.begin);


        for (var i = data.begin; i < end; i++) {
          console.log(i)
          $('<button></button>').attr({
            'id': userrooms[i].roomname,
            'data-toggle': "modal",
            'data-target': "#enterRoom"
          }).text('방이름: ' + userrooms[i].roomname + ' 방장: ' + userrooms[i].userid).appendTo('#container');
        }
        /*
        $.each(userrooms, function(index, item){
        console.log(index);
        $('<button></button>').attr({
        'id': item.roomname,
        'data-toggle': "modal",
        'data-target': "#enterRoom"
        }).text('방이름: '+ item.roomname +' 방장: '+ item.userid).appendTo('#container');

        });*/









        if (j > 1) {
          $('<a></a>').attr({
            onclick: 'refresh(1)',
            style: 'cursor: pointer'
          }).text("1[◀◀]").appendTo('#paging');
          $('<a></a>').attr({
            onclick: 'refresh(' + (j - 1) + ')',
            style: 'cursor: pointer'
          }).text("[◀]").appendTo('#paging');
        } else {
          $('<span></span>').attr({
            style: 'color: gray'
          }).text("[◀◀]").appendTo('#paging');
          $('<span></span>').attr({
            style: 'color: gray'
          }).text("[◀]").appendTo('#paging');
        }






        for (var i = data.startPage; i <= data.endPage; i++) {
          if (i == j) {
            $('<span></span>').text('<' + i + '>').appendTo('#paging');
          } else {

            $('<a></a>').attr({
              onclick: 'refresh(' + i + ')',
              style: 'cursor: pointer'

            }).text('<' + i + '>').appendTo('#paging');
          }
        }



        if (j < data.totalPage) {
          $('<a></a>').attr({
            onclick: 'refresh(' + (j + 1) + ')',
            style: 'cursor: pointer'
          }).text("[▶]").appendTo('#paging');
          $('<a></a>').attr({
            onclick: 'refresh(' + data.totalPage + ')',
            style: 'cursor: pointer'
          }).text("[▶▶]" + data.totalPage).appendTo('#paging');

        } else {
          $('<span></span>').attr({
            style: 'color: gray'
          }).text("[▶▶]").appendTo('#paging');
          $('<span></span>').attr({
            style: 'color: gray'
          }).text("[▶]").appendTo('#paging');
        }








      });

    }

    $(document).ready(function() {
      // 방목록 출력
      refresh(1);

      var socket = io.connect();
      //방생성시 목록 추가
      socket.on('onCreateRoom', function(data) {

        $('<button></button>').attr({
          'id': data.roomname,
          'data-toggle': "modal",
          'data-target': "#enterRoom"
        }).text('방이름: ' + data.roomname + ' 방장: ' + data.userid).appendTo('#container');

      });


      //모달 연결
      $('#container').on('click', 'button', function() {
        var roomname = $(this).attr('id');

        $(roomname2).val(roomname);

      });

      //방 생성
      $('#createRoom').click(function() {
        var roomName = $('#roomName').val();
        var roomPass = $('#roomPass').val();
        $('#roomPass').val('');

        if (roomPass == '' || roomName == '') {
          alert('공백입력 불가!');
          return;
        } else {
          $.ajax({
            type: 'GET',
            url: "/lobby/existCheck",
            data: {
              "roomname": roomName
            },
            success: function(result) {
              var out = JSON.parse(result);
              if (out.result == 'yes') {

                var userroom = {
                  userid: userid,
                  roomname: roomName,
                  roompass: roomPass,
                };

                socket.emit('onCreateRoom', userroom);
                $('#roomName').val('');

              } else {

                alert('동일한 이름의 방이 있습니다!');
                return;

              }
            }
          })
        }

      });

      //새로고침 버튼
      $('#refresh').click(function() {

        $('#container').empty();
        $('#paging').empty();

        refresh(1);

      });

      //새로고침 메소드
      /*            function refresh(){
                      $.getJSON('/lobby/roomList', function(data){
      				userrooms = data;
      				$.each(data, function(index, item){
      					$('<button></button>').attr({
      						'id': item.roomname,
                              'data-toggle': "modal",
                              'data-target': "#enterRoom"
      					}).text('방이름: '+ item.roomname +' 방장: '+                     userid).appendTo('#container');
      				    });
      			    });
                  }*/

    });

    function erase() {
      $('#searchText').val('');
      refresh(1);
    }
  </script>

</head>

<!--================================================================================-->

<body>

  <h1>
    <%= title %>
  </h1>
  <p>Welcome to
    <%= title %>
  </p>

  <p>
    <%= sess.mem_ID %>
  </p>
  <p>
    <%= sess.mem_Hash %>
  </p>

  <a href="http://localhost/Study_Anywhere/myPage.jsp">마이페이지</a> <br />

  <hr><br><br>

  <div>
    <div>
      <span>Room Name: </span>
      <input id="roomName">
      <span>Room Password: </span>
      <input type="password" id="roomPass">

      <button id="createRoom">Create Room</button>
      <button id="refresh">Refresh</button>
    </div>
    <div>
      <span>Search</span>
      <input type="text" onkeyup="search()" id="searchText">
      <button onclick="erase()">X</button>
    </div>
    <hr>

    <div id="container"></div>
    <div id="paging"></div>
  </div>
  <!--================================================================================-->
  <div class="modal" id="enterRoom">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">비밀번호를 입력해주세요</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <form action="/lobby/roomCheck" method="POST">
          <div class="form-group">
            <div class="modal-body">
              <h5>
                <label>방이름</label>
              </h5>
              <input class="form-control" name="rname" type="text" id="roomname2" readonly />
              <h5>
                <label>비밀번호</label>
              </h5>
              <input class="form-control" name="rpass" type="password" id="pwd" />
            </div>
            <div class="modal-footer">
              <button class="btn btn-dark" type="submit">들어가기</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!--================================================================================-->
  <!--        <div class="modal" id="createmodal">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">새로운 방을 개설합니다!</h4>
					<button type="button" class="close" data-dismiss="modal">&times;</button>
				</div>

				<form action="/lobby/roomCheck" method="POST">
					<div class="form-group">
						<div class="modal-body">
							<h5>
								<label>방이름</label>
							</h5>
							<input class="form-control" name="rname" type="text" id="roomname2" />
							<h5>
								<label>비밀번호</label>
							</h5>
							<input class="form-control" name="rpass" type="password"
								id="pwd" />
						</div>
						<div class="modal-footer">
                            <span id="existCheck" ></span>
							<button class="btn btn-dark" >방만들기</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>-->
  <!--================================================================================-->

</body>

</html>
