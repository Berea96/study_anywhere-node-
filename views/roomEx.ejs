<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title><%=title%></title>
  <!-- <script src="//code.jquery.com/jquery-1.12.0.min.js"></script> -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
  html {
    width: 98%;
    height: 98%;
  }
  body {
    width: 98%;
    height: 98%;
  }
  .head {
    width: 100%;
    height: 15%;
    background-color: red;
  }
  .left {
    float: left;
    width: 20%;
    height: 69%;
    background-color: blue;
  }
  .menu div {
    width: 100%;
    height: 30px;
    text-align: center;
    background-color: white;
    border: 1px solid;

  }
  .center {
    float: left;
    width: 60%;
    height: 69%;
  }
  #chatLogs {
    border: 1px solid;
    top: 150px;
    height: 150px;
    width:100%;
    overflow-y: scroll;
    word-wrap: break-word;
    word-break: break-all;
    background-color: #cadff2;
  }
  .form-inline {
    width: 100%;
  }
  .right {
    float: left;
    width: 20%;
    height: 69%;
    background-color: yellow;
  }
  #join {
    position: relative;
    border: 1px solid;
    overflow-y: scroll;
    word-wrap: break-word;
    word-break: break-all;
    width: 99%;
    height: 99%;
    background-color: white;
  }
  .currentTime {
    text-align: center;
  }
  #chatLogs {
    position: relative;
  }
  #input-group {
    position: relative;
    top: 150px;
    width: 400px;
  }
  #msgForm {
    margin-left: 3px;
    width: 70%;
  }
  #send {
    width: 50px;
  }
  #bottom {
    width: 30px;
  }
  .footer {
    clear: both;
    width: 100%;
    height: 15%;
    background-color: orange;
  }
</style>
<script type="text/javascript">
  var socket = io.connect();
  var user = [];

  $(document).ready(() => {

    $("#canvas").click(() => {
      var form = document.form1;
      window.open("", "canvas", "width=720, height=415");

      form.action = "http://localhost:3000/room/canvas";
      form.target = "canvas";
      form.roomname.value = $(".head").html();
      form.submit();
    });

    $("#board").click(() => {
      alert("게시판 준비중");
    });

    $("#timer").click(() => {
      window.open("http://localhost:3000/room/timer", "timer", "width=335, height=150, top=605, left=-10");
    });

    $("#calendar").click(() => {
      alert("달력 준비중");
    });

    var roomname = $(".head").html();

    //socket.emit("join", roomname);

    socket.emit("login", {
      "roomname": roomname,
      "name": '<%=name%>',
      userid: "11111@11111.com"
    });

    socket.on("login", (data) => {
      // $("#chatLogs").append("<div>" + data + "님이 입장하였습니다.</div>");
      // user.push(data);
      $("#join").empty();
      $.each(data, (index, item) => {
        $("#join").append("<div id=" + item + ">" + item + " 온라인</div>");
      })
    });

    socket.on("getUser", (data) => {
      $("#chatLogs").append("<div>" + data + "님이 입장하였습니다.</div>");
      user.push(data);

      socket.emit("joinUser", user);
    });

    // socket.emit("getTime", "");

    socket.on("setTime", (data) => {
      // console.log("도착");
      getTime();
    });

    $(() => {
      setInterval(() => {
        socket.emit("getTime", "");
      }, 1000);
    });

    function getTime() {
      var time = new Date();
      var timeArray = time.toString().split(" ");
      $(".currentTime").html(timeArray[4] + " " + timeArray[0]);
      //console.log(timeArray[0]);
    }

    socket.on("chat", (data) => {
      $("#chatLogs").append("<div id='bg'>" + data.from.name + " : " + data.msg + "</div>");
      // document.getElementById("chatLogs").scrollTop = document.getElementById("chatLogs").scrollHeight;
      if((document.getElementById("chatLogs").scrollTop / 100) * 100 != document.getElementById("chatLogs").scrollHeight - 300) {
        console.log("안맞음");
      }
      else {
        console.log("맞음");
      }
    });

    socket.on("exit", (data) => {
      if(data.name != "") {
        $("#chatLogs").append("<div>" + data.name + "님이 나가셨습니다.</div>");
        $("#" + data.name + "").remove();
      }
      else return;
    });

    $("#chatLogs").scroll((event) => {
      console.log("스크롤");
      console.log(document.getElementById("chatLogs").scrollTop);
      console.log(document.getElementById("chatLogs").scrollHeight);

      if(Math.round(document.getElementById("chatLogs").scrollTop) != document.getElementById("chatLogs").scrollHeight - 300) {
        console.log("안맞음");
      }
      else {
        console.log("맞음");
      }

      $("#bottom").css("bottom", "5px");
    });

    $("#bottom").click(() => {
      $("#chatLogs").animate({scrollTop:  document.getElementById("chatLogs").scrollHeight}, 1500);
    });

    // $("#send").click(() => {
      //   var $msgForm = $("#msgForm");
      //   socket.emit("chat", {msg: $msgForm.val()});
      // });

      $("form").submit((e) => {
        var $msgForm = $("#msgForm");

        socket.emit("chat", {msg: $msgForm.val()});
        $msgForm.val("");
        e.preventDefault();
      });
    });
  </script>
</head>
<body>
  <div class="head"><%=roomname%></div>
  <div class="left">
    왼손
    <div class="menu" id="menu">
      <form class="form1" name="form1" method="post">
        <div class="divs" id="canvas">그림판</div>
        <div class="divs" id="board">게시판</div>
        <div class="divs" id="timer">타이머</div>
        <div class="divs" id="calendar">달력</div>
        <input type="hidden" name="roomname">
      </form>
    </div>
  </div>
  <div class="center">
    <div class="currentTime">
      Welcome
    </div>
    <div id="chatLogs">
    </div>
    <div id="input-group" class="form-group">
      <form class="form-inline" action="">
        <input type="text" class="form_control" id="msgForm" autocomplete="off">
        <button type="submit" id="send" class="btn btn-primary">Send</button>
        <input type="button" id="bottom" name="button" value="↓">
      </form>
    </div>
  </div>
  <div class="right">

    <div id="join"></div>
  </div>
  <div class="footer">
    다리~
  </div>
</body>
</html>
